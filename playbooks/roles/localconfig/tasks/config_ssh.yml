# vim: ts=2 sw=2 expandtab ai
---
- name: ensure ~/.ssh dir exists
  run_once: true
  file:
    path: "{{ sshconfig_path | dirname }}"
    mode: 0700
    state: directory

- name: ensure ~/.ssh/config file exists
  run_once: true
  copy:
    dest: "{{ sshconfig_path }}"
    content: ''
    mode: 0640
    force: false

- name: removing from ssh config
  when: sshconfig_clean
  run_once: true
  blockinfile:
    marker: "# {mark} SAT-DEMO MANAGED BLOCK"
    path: "{{ sshconfig_path }}"
    state: absent

- name: adding to ssh config
  when: not sshconfig_clean
  run_once: true
  blockinfile:
    marker: "# {mark} SAT-DEMO MANAGED BLOCK"
    path: "{{ sshconfig_path }}"
    block: |
      {% for hn in play_hosts %}
      {% set hv = hostvars[hn] %}
      Host {{ hn }} {{ hv.hostname }} {{ hv.public_ip | default('') }} {{ hv.internal_ip | default('') }}
        Hostname {{ hv.public_ip }}
        UserKnownHostsFile /dev/null
        StrictHostKeyChecking no
        User {{ hv.ansible_user }}
      {% endfor %}
